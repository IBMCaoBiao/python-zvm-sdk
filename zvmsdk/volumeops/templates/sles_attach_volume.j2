#!/bin/bash
# Generated by jinja2 template
fcp="{{ fcp }}"
lun="{{ lun }}"
target_filename="{{ target_filename }}"

echo "Enter SLES attach script with parameters: $fcp $lun $target_filename."

# see if zfcp is enable
enable_zfcp_mod=`lsmod | grep zfcp`
if [ -z "$enable_zfcp_mod" ];then
    modprobe zfcp
else
    echo "zfcp mode is already enabled"
fi

# online the fcp device
/sbin/cio_ignore -r $fcp > /dev/null
/sbin/chccwdev -e $fcp > /dev/null


declare -a ActiveWWPNs
ActiveWWPNs=(`ls /sys/bus/ccw/drivers/zfcp/0.0.$fcp/ | grep "0x"`)
echo "Get active WWPNs in sles attach script: ${ActiveWWPNs[@]}"

# the host name of the FCP devices, for example
# the host name of "0.0.5c0c host0" is host0
# we need it to comprise the path of some files
HostName=`lszfcp | grep "$fcp" | cut -d " " -f 2`
echo "Get host name in sles attach script: $HostName"

# see if NPIV is enable or not
NPIV=`cat /sys/bus/ccw/drivers/zfcp/0.0.$fcp/$HostName/fc_host/$HostName/port_type`

# TODO: no auto port rescan?

# If auto-discovery of LUNs is disabled on s390 platforms
# luns need to be added to the configuration through
# the unit_add interface
AutoScan=`cat /sys/module/zfcp/parameters/allow_lun_scan`
if [[ "$AutoScan" != "Y" || "$NPIV" != "NPIV VPORT" ]]; then
    for wwpn in ${ActiveWWPNs[@]}
    do
        chzdev -e -a zfcp-lun 0.0.$fcp:$wwpn:$lun
    done
fi

# create udev rules
sleep 1
touch /etc/udev/rules.d/51-zfcp-0.0.$fcp.rules
out=`cat "/etc/udev/rules.d/51-zfcp-0.0.$fcp.rules" | egrep -i "ccw/0.0.$fcp]online"`
if [[ ! $out ]]; then
  echo "ACTION==\"add\", SUBSYSTEM==\"ccw\", KERNEL==\"0.0.$fcp\", IMPORT{program}=\"collect 0.0.$fcp %k 0.0.$fcp zfcp\""| tee -a /etc/udev/rules.d/51-zfcp-0.0.$fcp.rules
  echo "ACTION==\"add\", SUBSYSTEM==\"drivers\", KERNEL==\"zfcp\", IMPORT{program}=\"collect 0.0.$fcp %k 0.0.$fcp zfcp\""| tee -a /etc/udev/rules.d/51-zfcp-0.0.$fcp.rules
  echo "ACTION==\"add\", ENV{COLLECT_0.0.$fcp}==\"0\", ATTR{[ccw/0.0.$fcp]online}=\"1\""| tee -a /etc/udev/rules.d/51-zfcp-0.0.$fcp.rules
fi
for wwpn in ${ActiveWWPNs[@]}
do
    echo "ACTION==\"add\", KERNEL==\"rport-*\", ATTR{port_name}==\"$wwpn\", SUBSYSTEMS==\"ccw\", KERNELS==\"0.0.$fcp\",ATTR{[ccw/0.0.$fcp]$wwpn/unit_add}=\"$lun\""| tee -a /etc/udev/rules.d/51-zfcp-0.0.$fcp.rules
done
if [[ $(which udevadm 2> /dev/null) != '' ]]; then
    udevadm settle
else
    udevsettle
fi

# send an iSCSI scan request with given host and optionally the ctl 
# the ctl means, c: channel,default to -
#                t: target, default to -
#                l: lun, default to -
all_hosts=(`ls /sys/class/scsi_host/`)
for host in ${all_hosts[@]}
do
    echo "- - -" > /sys/class/scsi_host/$host/scan
    echo "scan request to host $host sent."
done

# wait for the devices ready
FoundDiskPath=0
# timeout set to 60 seconds
Timeout=60
while [ $FoundDiskPath -eq 0 ]
do
    # if timeout less or equal 0 seconds, means no time left
    if [ $Timeout -le 0 ]; then
        echo "waiting for devices ready timed out after 60 seconds."
        break
    fi
    # loop all the WWPNs to found the alive device
    for j in ${ActiveWWPNs[@]}
    do
        x="/dev/disk/by-path/ccw-0.0.$fcp-zfcp-$j:$lun"
        # the x would be like:
        # ccw-0.0.1d13-zfcp-0x5005076306035388:0x4014400400000000
        echo "try disk path:$x"
        if [ -e $x ]; then
            diskPath=$x
            FoundDiskPath=1
            echo "Found disk path is: $diskPath"
            break
        fi
    done
    # if devices still not ready, wait another 5 seconds and retry
    if [ $FoundDiskPath -eq 0 ]; then
        sleep 5
        Timeout=$((Timeout-=5))
        echo "sleep 5 seconds to wait the devices ready, timeout left: $Timeout"
    fi
done
if [ $FoundDiskPath -ne 1 ]; then
    echo "error happens during attachment because the device file not found, will exit with code 1."
    exit 1
fi

# ensure multipathd service is up
enable_multipath_mod=`lsmod | grep dm_multipath`
if [ -z "$enable_multipath_mod" ];then
    modprobe dm-multipath
    echo -e "#blacklist {
    #   devnode \"*\"
    #}
    " > /etc/multipath.conf
    mpathconf
    systemctl restart multipathd.service
else
    echo "dm-multipath mode is already enabled"
fi

WWID=`/lib/udev/scsi_id --page 0x83 --whitelisted $diskPath`
echo "Get WWID in sles attach script: $WWID"

ConfigLib="/lib/udev/rules.d/56-zfcp.rules"
if [ -e "$ConfigLib" ]
then
    ConfigFile="/lib/udev/rules.d/56-zfcp.rules"
else
    ConfigFile="/etc/udev/rules.d/56-zfcp.rules"
fi

LinkItem="KERNEL==\"dm-*\", ENV{DM_UUID}==\"mpath-$WWID\", SYMLINK+=\"$target_filename\""
echo -e $LinkItem >> $ConfigFile

udevadm control --reload
udevadm trigger --sysname-match=dm-*

exit 0

